{% extends 'index.html' %}


{% block content %}
<h2>Administrar Grupos y Permisos</h2>

<form method="post">
    {% csrf_token %}
    <label for="new_group_name">Crear Nuevo Grupo:</label>
    <input type="text" id="new_group_name" name="new_group_name" required>
    <button type="submit">Crear Grupo</button>
</form>

<table>
    <thead>
        <tr>
            <th>Permiso</th>
            {% for group in user_groups %}
                <th>{{ group.name }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for permission in permissions %}
            <tr>
                <td>{{ permission.name }}</td>
                {% for group in user_groups %}
                    <td>
                        <input 
                            type="checkbox" 
                            name="permission_{{ permission.id }}_group_{{ group.id }}"
                            {% if permission in group.permissions.all %}
                                checked
                            {% endif %}
                        >
                    </td>
                {% endfor %}
            </tr>
        {% endfor %}
    </table>
    <button type="submit">Guardar Cambios</button>
</form>
{% endblock %}

{% block javascript %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    const saveButton = document.querySelector('button[type="submit"]');

    checkboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            saveButton.disabled = false;
        });
    });

    saveButton.addEventListener('click', function(event) {
        event.preventDefault();

        const formData = new FormData(event.target.closest('form'));

        fetch('/manage-groups/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value
            }
        })
        .then(function(response) {
            if (response.ok) {
                alert('Permisos guardados correctamente.');
                saveButton.disabled = true;
            } else {
                alert('Error al guardar los permisos. Por favor, inténtalo de nuevo.');
            }
        })
        .catch(function(error) {
            alert('Ha ocurrido un error. Por favor, inténtalo de nuevo más tarde.');
        });
    });
});
</script>
{% endblock %}
    